{% extends 'base.html' %}
{% block title %}{{ movie.display_title }} - 电影推荐系统{% endblock %}

{% block body_class %}full-bleed-header{% endblock %}

{% block content %}

<!-- 1. 顶部背景图区域 -->
<div class="movie-detail-header" {% if movie.backdrop_url %}style="background-image: url('{{ movie.backdrop_url }}');"{% endif %}>
    <div class="detail-header-content">
        <div class="detail-main-info">
            <img src="{{ movie.poster_url }}" alt="{{ movie.display_title }}" class="detail-poster">
            <div class="detail-title-group">
                <h1>{{ movie.display_title }}</h1>
                <p class="meta">
                    {{ movie.release_year }}
                    {% if movie.directors.all %}
                        - Directed by
                        {% for director in movie.directors.all %}
                            <a>{{ director.name }}</a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </p>

                <!-- 操作按钮区域 -->
                {% if user.is_authenticated %}
                <div class="action-buttons">
                    <!-- 收藏按钮 -->
                    <form action="{% url 'movie_frontend:toggle_watchlist' movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn primary-btn">
                            {% if is_in_watchlist %} 从收藏中移除 {% else %} 添加到收藏 {% endif %}
                        </button>
                    </form>
                    <!-- 喜欢按钮 -->
                    <form action="{% url 'movie_frontend:toggle_favorite' movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn favorite-btn {% if is_in_favorites %}favorited{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 2. 主体内容区域 -->
<div class="container movie-detail-body">
    <div class="genres">
        {% for genre in movie.genres.all %}
            <span class="genre-tag">{{ genre.name }}</span>
        {% endfor %}
    </div>

    {% if movie.summary %}
    <section class="summary">
        <h2>剧情简介</h2>
        <p>{{ movie.summary }}</p>
    </section>
    {% endif %}

    {% if movie.actors.all %}
    <section class="cast">
        <h2>主演</h2>
        <div class="cast-grid">
        {% for actor in movie.actors.all %}
            <div class="cast-member">{{ actor.name }}</div>
        {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="reviews-section">
        <h2>评论</h2>
        <div class="reviews-list">
            {% for review in reviews %}
                <div class="review-card">
                    <div class="review-header">
                        <span class="review-source">{{ review.source.name }}</span>
                        {% if review.score is not None %}
                            <span class="review-score">{{ review.score|floatformat:1 }}/{{ review.source.score_max|floatformat:0 }}</span>
                        {% endif %}
                    </div>
                    <div class="review-content">
                        <p>{{ review.content }}</p>
                    </div>
                </div>
            {% empty %}
                <p>暂无评论。</p>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}