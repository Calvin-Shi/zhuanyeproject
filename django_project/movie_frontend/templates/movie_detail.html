{% extends 'base.html' %}
{% block title %}{{ movie.display_title }} - 电影推荐系统{% endblock %}

{% block body_class %}full-bleed-header{% endblock %}

{% block content %}

<!-- 1. 顶部背景图区域 -->
<div class="movie-detail-header" {% if movie.backdrop_url %}style="background-image: url('{{ movie.backdrop_url }}');"{% endif %}>
    <div class="detail-header-content">
        <div class="detail-main-info">
            <img src="{{ movie.poster_url }}" alt="{{ movie.display_title }}" class="detail-poster">
            <div class="detail-title-group">
                <!-- MODIFIED: 将返回按钮移动到标题上方 -->
                <button onclick="history.back()" class="btn-back">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    返回
                </button>
                <h1>{{ movie.display_title }}</h1>
                <p class="meta">
                    {{ movie.release_year }}
                    {% if movie.directors.all %}
                        - Directed by
                        {% for director in movie.directors.all %}
                            <a>{{ director.name }}</a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </p>

                <!-- 操作按钮区域 -->
                {% if user.is_authenticated %}
                <div class="action-buttons">
                    <!-- 收藏按钮 -->
                    <form action="{% url 'movie_frontend:toggle_watchlist' movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn primary-btn">
                            {% if is_in_watchlist %} 从收藏中移除 {% else %} 添加到收藏 {% endif %}
                        </button>
                    </form>
                    <!-- 喜欢按钮 -->
                    <form action="{% url 'movie_frontend:toggle_favorite' movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn favorite-btn {% if is_in_favorites %}favorited{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 2. 主体内容区域 -->
<div class="container movie-detail-body">
    <div class="genres">
        {% for genre in movie.genres.all %}
            <span class="genre-tag">{{ genre.name }}</span>
        {% endfor %}
    </div>

    {% if movie.summary %}
    <section class="summary">
        <h2>剧情简介</h2>
        <p>{{ movie.summary }}</p>
    </section>
    {% endif %}

    {% if movie.actors.all %}
    <section class="cast">
        <h2>主演</h2>
        <div class="cast-grid">
        {% for actor in movie.actors.all %}
            <div class="cast-member">{{ actor.name }}</div>
        {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- MODIFIED: 评论区重构 -->

    <section class="reviews-section">

        <!-- 新增: 发表评论表单 -->
        {% if user.is_authenticated %}
        <div class="comment-form-container card">
            <h2>发表你的看法</h2>
            <form id="comment-form" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ review_form.rating.id_for_label }}">{{ review_form.rating.label }}</label>
                    {{ review_form.rating }}
                    {% if review_form.rating.help_text %}<small class="form-help-text">{{ review_form.rating.help_text }}</small>{% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ review_form.review.id_for_label }}">{{ review_form.review.label }}</label>
                    {{ review_form.review }}
                </div>
                {% if review_form.errors %}{% for field, errors in review_form.errors.items %}{% for error in errors %}<p class="form-error">{{ error }}</p>{% endfor %}{% endfor %}{% endif %}
                <button type="submit" class="btn primary-btn">发布评论</button>
            </form>
        </div>
        {% else %}
        <p><a href="{% url 'login' %}?next={{ request.path }}">登录</a>后即可发表评论。</p>
        {% endif %}

        <!-- 新增: 本站用户评论 -->
        <h2 style="margin-top: 3rem;">用户评论</h2>
        <div class="reviews-list">
            {% for review in user_reviews %}
                <div class="review-card">
                    <div class="review-header">
                        <div class="review-author-info">
                            <span class="review-source">{{ review.user.username }}</span>
                            <small class="review-timestamp">{{ review.timestamp|date:"Y-m-d H:i" }}</small>
                        </div>
                        <span class="review-score">{{ review.rating|floatformat:1 }}/10.0</span>
                    </div>
                    <div class="review-content">
                        <p>{{ review.review|linebreaksbr }}</p>
                    </div>
                    <div class="review-footer">
                        <!-- MODIFIED: 点赞功能升级为AJAX -->
                        <div class="like-section" data-review-id="{{ review.id }}">
                            <button type="button" class="btn-like {% if review.id in liked_review_ids %}liked{% endif %}">
                                <!-- MODIFIED: 提供了完整的SVG图标代码 -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            </button>
                            <span class="like-count">赞同数: {{ review.likes_count }}</span>
                        </div>
                        {% if request.user == review.user %}
                            <div class="review-actions">
                                <a href="{% url 'movie_frontend:edit_review' review.id %}" class="btn-edit">编辑</a>
                                <form action="{% url 'movie_frontend:delete_review' review.id %}" method="post" onsubmit="return confirm('确定要删除这条评论吗？');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-delete">删除</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p>暂无用户评论，快来抢沙发吧！</p>
            {% endfor %}
        </div>

        <!-- 外部网站评论 -->
        <h2 style="margin-top: 3rem;">外部评论</h2>
        <div class="reviews-list">
            {% for review in external_reviews %}
                <div class="review-card">
                    <div class="review-header">
                        <div class="review-author-info">
                           <span class="review-source">{{ review.source.name }} {% if review.author %}(by {{ review.author }}){% endif %}</span>
                           {% if review.content_date %}<small class="review-timestamp">{{ review.content_date|date:"Y-m-d" }}</small>{% endif %}
                        </div>
                        {% if review.score is not None %}
                            <!-- MODIFIED: 修正分值上限显示 -->
                            <span class="review-score">{{ review.score|floatformat:1 }}/{{ review.source.score_max|floatformat:1 }}</span>
                        {% endif %}
                    </div>
                    <div class="review-content">
                        <p>{{ review.content }}</p>
                    </div>
                     {% if review.approvals_num is not None %}
                    <div class="review-footer">
                       <span>赞同数: {{ review.approvals_num }}</span>
                    </div>
                    {% endif %}
                </div>
            {% empty %}
                <p>暂无外部评论。</p>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll('.btn-like').forEach(button => {
        button.addEventListener('click', function() {
            const likeSection = this.closest('.like-section');
            const reviewId = likeSection.dataset.reviewId;

            fetch(`/review/${reviewId}/like/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({}) // 即使没有数据也要发送body
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // 更新点赞计数
                    const likeCountSpan = likeSection.querySelector('.like-count');
                    likeCountSpan.textContent = `赞同数: ${data.likes_count}`;

                    // 更新按钮样式
                    this.classList.toggle('liked', data.is_liked);
                }
            })
            .catch(error => console.error('点赞时出错:', error));
        });
    });
});
</script>
{% endblock %}