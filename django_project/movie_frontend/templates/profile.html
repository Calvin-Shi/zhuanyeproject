{% extends 'base.html' %}

{% block title %}个人资料 - 电影推荐系统{% endblock %}

{% block content %}
<section class="profile-container">
    <h1>个人资料</h1>

    {% if user.is_authenticated %}
        <!-- 用户基本信息 -->
        <div class="user-info">
            <!-- 昵称显示/编辑区域 -->
            <div class="info-item">
                <strong>昵称：</strong>
                <span class="info-display" id="nickname-display">
                    {{ user.profile.nickname|default:user.username }}
                </span>
                <input type="text"
                       class="info-input"
                       id="nickname-input"
                       value="{{ user.profile.nickname|default:'' }}"
                       style="display:none;"
                       maxlength="100">
            </div>

            <!-- 签名显示/编辑区域 -->
            <div class="info-item">
                <strong>个人签名：</strong>
                <p class="info-display" id="signature-display">
                    {{ user.profile.signature|default:"未设置签名" }}
                </p>
                <textarea class="info-input"
                          id="signature-input"
                          rows="3"
                          style="display:none;"
                          maxlength="500">{{ user.profile.signature|default:'' }}</textarea>
            </div>

            <p><strong>用户名：</strong>{{ user.username }}</p>
            {% if user.email %}
                <p><strong>邮箱：</strong>{{ user.email }}</p>
            {% endif %}

            <!-- 操作按钮 -->
            <button id="edit-btn" class="btn-primary">修改信息</button>
        </div>

        <!-- 我喜欢的电影栏 -->
        <div class="favorite-movies-section">
            <div class="section-header">
                <h3>我喜欢的电影</h3>
                <p>这些是你在"选择你喜欢的电影"中勾选的影片</p>
            </div>

            {% if favorite_movies %}
                <div class="movies-grid">
                    {% for movie in favorite_movies %}
                        <div class="movie-card">
                            <div class="movie-info">
                                <h4 class="movie-title">
                                    <a href="{% url 'movie_frontend:movie_detail' movie.id %}">
                                        {{ movie.display_title }}
                                    </a>
                                </h4>
                                <div class="movie-meta">
                                    <span class="release-year">{{ movie.release_year }}</span>
                                    <div class="genres">
                                        {% for genre in movie.genres.all|slice:":3" %}
                                            <span class="genre-badge">{{ genre.name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fa fa-film"></i>
                    <p>你还没有选择喜欢的电影</p>
                    <a href="{% url 'movie_frontend:choose_favorites' %}" class="btn-primary">
                        去选择喜欢的电影
                    </a>
                </div>
            {% endif %}
        </div>

    {% else %}
        <div class="login-prompt">
            <p>请先登录查看个人资料</p>
            <a href="{% url 'movie_frontend:login' %}" class="btn-primary">登录</a>
        </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_css %}
<style>
    .user-info {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .info-item {
        margin: 15px 0;
    }

    .info-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 5px;
    }

    .btn-primary {
        display: inline-block;
        background: #2c3e50;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
    }

    .btn-primary:hover {
        background: #34495e;
    }

    .btn-success {
        background: #27ae60;
    }

    .btn-success:hover {
        background: #219653;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>

const editBtn = document.getElementById('edit-btn');
const nicknameDisplay = document.getElementById('nickname-display');
const nicknameInput = document.getElementById('nickname-input');
const signatureDisplay = document.getElementById('signature-display');
const signatureInput = document.getElementById('signature-input');
let isEditing = false;

// 切换编辑状态
editBtn.addEventListener('click', function() {
    if (!isEditing) {
        // 进入编辑模式
        nicknameDisplay.style.display = 'none';
        nicknameInput.style.display = 'block';
        signatureDisplay.style.display = 'none';
        signatureInput.style.display = 'block';
        editBtn.textContent = '确认修改';
        editBtn.classList.add('btn-success');
        isEditing = true;
    } else {
        // 提交修改
        submitChanges();
    }
});

// 提交修改到后端
function submitChanges() {
    const formData = new FormData();
    formData.append('nickname', nicknameInput.value);
    formData.append('signature', signatureInput.value);

    fetch('{% url "movie_frontend:profile" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 更新显示内容
            nicknameDisplay.textContent = data.nickname || '{{ user.username }}';
            signatureDisplay.textContent = data.signature || '未设置签名';

            // 退出编辑模式
            nicknameInput.style.display = 'none';
            signatureInput.style.display = 'none';
            nicknameDisplay.style.display = 'inline';
            signatureDisplay.style.display = 'block';
            editBtn.textContent = '修改信息';
            editBtn.classList.remove('btn-success');
            isEditing = false;
        } else {
            alert('修改失败：' + JSON.stringify(data.errors));
        }
    })
    .catch(error => console.error('提交失败：', error));
}
</script>
{% endblock %}