{% extends 'base.html' %}
{% load url_helpers %}
{% block title %}选择你的喜好{% endblock %}

{% block content %}
<div class="container">
    <h1>选择你的喜好</h1>
    <p>你可以直接添加喜欢的演员、导演或类型，也可以在下方勾选具体的电影。</p>

    <!-- 选项卡式发现中心 -->
    <div class="browse-container card">
        <div class="browse-tabs">
            <button class="tab-button" data-tab="search">搜索</button>
            <button class="tab-button" data-tab="genres">电影类型</button>
            <button class="tab-button" data-tab="people">导演/演员</button>
        </div>
        <div class="tab-content-container">
            <!-- 搜索选项卡 -->
            <div class="tab-pane" id="tab-search">
                <form id="entity-search-form" class="entity-search-form" onsubmit="return false;">
                    <div class="search-bar-wrapper">
                        <input type="text" name="q" id="search-input" placeholder="输入后自动搜索电影、演员、导演或类型..." value="{{ query|default:'' }}" class="search-input">
                        {# 移除了提交按钮，改为输入时自动搜索 #}
                    </div>
                </form>
            </div>
            <!-- 浏览类型选项卡 -->
            <div class="tab-pane" id="tab-genres">
                <div class="entity-pills-grid">
                    {% for genre in all_genres %}
                    <button type="button" class="entity-pill btn-toggle-entity {% if genre.id in favorite_genre_ids %}added{% endif %}" data-entity-type="genre" data-entity-id="{{ genre.id }}" data-entity-name="{{ genre.name }}">
                        {% if genre.id in favorite_genre_ids %}✓ {% endif %}{{ genre.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <!-- 发现人物选项卡 -->
            <div class="tab-pane" id="tab-people">
                <div class="sub-tabs">
                    <button class="sub-tab-button active" data-target="#directors-pane">导演</button>
                    <button class="sub-tab-button" data-target="#actors-pane">演员</button>
                </div>

                <div id="directors-pane" class="sub-tab-pane active">
                    {% include 'partials/_people_grid.html' with page_obj=page_obj_directors favorite_people_ids=favorite_people_ids param_name='director_page' %}
                </div>

                <div id="actors-pane" class="sub-tab-pane">
                    {# 初始为空，由AJAX填充 #}
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="search-results-container">
        {% include 'partials/_favorites_search_results.html' %}
    </div>
</div>

<div id="floating-actions-bar" class="actions-bar floating">
    <div class="container">
        <span id="selection-counter"></span>
        <button type="submit" form="favorites-form" class="btn primary-btn">提交喜好，查看推荐</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const body = document.body;
    const floatingBar = document.getElementById('floating-actions-bar');
    const counter = document.getElementById('selection-counter');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const searchInput = document.getElementById('search-input');
    const searchResultsContainer = document.getElementById('search-results-container');

    const initialFavoriteIds = new Set({{ initial_favorite_movie_ids_json|safe }});
    let selectedMovieIds = new Set(initialFavoriteIds);
    let userHasInteracted = false;
    let debounceTimer; // 用于防抖的计时器

    // --- 核心逻辑函数 ---

    function updateFloatingBar() {
        const count = selectedMovieIds.size;
        if (count > 0) {
            if (!userHasInteracted && initialFavoriteIds.size > 0 && count === initialFavoriteIds.size) {
                counter.textContent = `当前已有 ${count} 部喜好电影，可继续添加或修改`;
            } else {
                counter.textContent = `已选择 ${count} 部电影`;
            }
            floatingBar.classList.add('visible');
            body.classList.add('floating-bar-active');
        } else {
            floatingBar.classList.remove('visible');
            body.classList.remove('floating-bar-active');
        }
    }

    function initializeEntityToggleButtons(container) {
        container.querySelectorAll('.btn-toggle-entity').forEach(button => {
            if (button.dataset.initialized) return;
            button.dataset.initialized = true;
            const entityName = button.dataset.entityName;
            button.addEventListener('click', function() {
                const entityType = this.dataset.entityType;
                const entityId = this.dataset.entityId;
                fetch("{% url 'movie_frontend:toggle_favorite_entity' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                    body: JSON.stringify({entity_type: entityType, entity_id: entityId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        if (data.action === 'added') {
                            this.innerHTML = `✓ ${entityName}`; this.classList.add('added');
                        } else {
                            this.innerHTML = entityName; this.classList.remove('added');
                        }
                    }
                });
            });
        });
    }

    function initializeMovieCheckboxes(container) {
        container.querySelectorAll('.favorite-checkbox').forEach(checkbox => {
            const movieId = parseInt(checkbox.value);
            checkbox.checked = selectedMovieIds.has(movieId);
            checkbox.addEventListener('change', () => {
                userHasInteracted = true;
                if (checkbox.checked) {
                    selectedMovieIds.add(movieId);
                } else {
                    selectedMovieIds.delete(movieId);
                }
                updateFloatingBar();
            });
        });
    }

    // --- 带防抖的AJAX搜索 ---
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = searchInput.value;
            if (query.trim() === '' && "{{ query|default:'' }}" === '') {
                // 只有当初始也无查询且输入框也为空时才不搜索
                return;
            }
            const url = `{% url 'movie_frontend:choose_favorites' %}?q=${encodeURIComponent(query)}`;
            searchResultsContainer.style.opacity = '0.5';
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                searchResultsContainer.innerHTML = html;
                searchResultsContainer.style.opacity = '1';
                initializeMovieCheckboxes(searchResultsContainer);
                initializeEntityToggleButtons(searchResultsContainer);
                updateFloatingBar();
            })
            .catch(error => { console.error('搜索时出错:', error); searchResultsContainer.style.opacity = '1'; });
        }, 350); // 延迟350毫秒
    });

    // --- AJAX 人物分页 ---
    function initializeAjaxPagination(containerSelector, partialName) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        container.addEventListener('click', function(event) {
            if (event.target.tagName === 'A' && event.target.closest('.pagination-links')) {
                event.preventDefault();
                const url = event.target.href;
                const finalUrl = new URL(url);
                finalUrl.searchParams.set('partial', partialName);
                container.style.opacity = '0.5';
                fetch(finalUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.text())
                .then(html => {
                    container.innerHTML = html;
                    container.style.opacity = '1';
                    initializeEntityToggleButtons(container);
                })
                .catch(error => { console.error('分页时出错:', error); container.style.opacity = '1'; });
            }
        });
    }

    // --- AJAX 子选项卡切换 ---
    const subTabsContainer = document.querySelector('.sub-tabs');
    if (subTabsContainer) {
        subTabsContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('sub-tab-button')) {
                const button = event.target;
                if (button.classList.contains('active')) return;
                subTabsContainer.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetPaneId = button.dataset.target;
                document.querySelectorAll('.sub-tab-pane').forEach(pane => pane.classList.remove('active'));
                const targetPane = document.querySelector(targetPaneId);
                targetPane.classList.add('active');
                if (targetPaneId === '#actors-pane' && !targetPane.querySelector('.entity-pills-grid')) {
                    const url = `{% url 'movie_frontend:choose_favorites' %}?partial=actors`;
                    targetPane.style.opacity = '0.5';
                    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(response => response.text())
                    .then(html => {
                        targetPane.innerHTML = html;
                        targetPane.style.opacity = '1';
                        initializeEntityToggleButtons(targetPane);
                        initializeAjaxPagination('#actors-pane', 'actors');
                    })
                    .catch(error => { console.error('加载演员列表时出错:', error); targetPane.style.opacity = '1'; });
                }
            }
        });
    }

    // --- 表单提交 (事件委托) ---
    document.addEventListener('submit', function(event) {
        if (event.target.id === 'favorites-form') {
            event.preventDefault();
            const form = event.target;
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'favorite_ids_json';
            hiddenInput.value = JSON.stringify(Array.from(selectedMovieIds));
            form.appendChild(hiddenInput);
            form.submit();
        }
    });

    // --- 主选项卡切换 ---
    function activateMainTab(tabId) {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
        tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === 'tab-' + tabId));
    }
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => { button.addEventListener('click', function() { activateMainTab(this.dataset.tab); }); });
    const initialMainTab = new URLSearchParams(window.location.search).get('main_tab') || 'search';
    activateMainTab(initialMainTab);

    // --- 页面初次加载时初始化所有交互 ---
    initializeEntityToggleButtons(document);
    initializeMovieCheckboxes(document);
    updateFloatingBar();
    initializeAjaxPagination('#directors-pane', 'directors');
    initializeAjaxPagination('#actors-pane', 'actors');
});
</script>
{% endblock %}