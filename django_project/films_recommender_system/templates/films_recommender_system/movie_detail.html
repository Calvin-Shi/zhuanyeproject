{% extends 'base.html' %}

{% block title %}{{ movie }}{% endblock %}

{% block content %}
<!-- 电影基本信息 (由Django在服务器端渲染) -->
<div class="card mb-4">
    <div class="card-body">
        <h1 class="card-title display-5">{{ movie.original_title }}</h1>
        <h4 class="card-subtitle mb-2 text-muted">{{ movie }}</h4>
        <p><strong>上映年份:</strong> {{ movie.release_year }}</p>
        <p><strong>类型:</strong>
            {% for genre in movie.genres.all %}
                <span class="badge bg-secondary">{{ genre.name }}</span>
            {% endfor %}
        </p>
        <p class="card-text">{{ movie.summary }}</p>
    </div>
</div>

<!-- 用户评论区 -->
<div class="row">
    <!-- 左侧：评论列表 -->
    <div class="col-md-8">
        <h3>用户评论</h3>
        <hr>
        <!-- 评论列表将由下面的 JavaScript 动态填充到这里 -->
        <div id="review-list">
            <p id="loading-reviews">正在加载评论...</p>
        </div>
    </div>

    <!-- 右侧：发表评论表单 -->
    <div class="col-md-4">
        <h3>发表你的评论</h3>
        <hr>
        <form id="review-form" data-movie-id="{{ movie.id }}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="rating" class="form-label">评分 (1-5)</label>
                <select class="form-select" id="rating" name="rating" required>
                    <option value="5">5 - 强烈推荐</option>
                    <option value="4">4 - 比较推荐</option>
                    <option value="3" selected>3 - 一般</option>
                    <option value="2">2 - 不太推荐</option>
                    <option value="1">1 - 浪费时间</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="review-text" class="form-label">评论内容</label>
                <textarea class="form-control" id="review-text" name="review" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">提交评论</button>
        </form>
        <!-- 这个 div 用于显示提交后的成功或失败信息 -->
        <div id="form-message" class="mt-3"></div>
    </div>
</div>

<!-- JavaScript 代码块 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewList = document.getElementById('review-list');
    const form = document.getElementById('review-form');
    const messageDiv = document.getElementById('form-message');

    const movieId = form.dataset.movieId;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    /**
     * 功能 1: 通过 API 获取并显示某部电影的所有评论
     */
    function fetchReviews() {
        // 使用查询参数来指定需要哪部电影的评论
        fetch(`/api/reviews/?movie_id=${movieId}`)
            .then(response => response.json())
            .then(reviews => {
                reviewList.innerHTML = ''; // 清空 "正在加载..." 提示

                if (reviews && reviews.length > 0) {
                    reviews.forEach(review => {
                        // 使用 toLocaleString() 来格式化日期，使其更友好
                        const formattedTimestamp = new Date(review.timestamp).toLocaleString();
                        const reviewCard = `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <p><strong>${review.user_info.username}</strong> 打了 <strong>${review.rating}/5</strong> 分</p>
                                    <p>${review.review}</p>
                                    <small class="text-muted">${formattedTimestamp}</small>
                                </div>
                            </div>
                        `;
                        reviewList.innerHTML += reviewCard;
                    });
                } else {
                    reviewList.innerHTML = '<p id="no-reviews-message">暂无用户评论，快来抢沙发吧！</p>';
                }
            })
            .catch(error => {
                console.error('加载评论失败:', error);
                reviewList.innerHTML = '<p class="text-danger">评论加载失败，请刷新页面重试。</p>';
            });
    }

    // 页面加载完成后，立即执行获取评论的函数
    fetchReviews();

    /**
     * 功能 2: 处理评论表单的提交，包含完整的成功/失败反馈
     */
    form.addEventListener('submit', function(event) {
        event.preventDefault(); // 阻止表单默认的刷新页面的行为

        const rating = document.getElementById('rating').value;
        const reviewText = document.getElementById('review-text').value;

        fetch('/api/reviews/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                movie: movieId,
                rating: parseInt(rating),
                review: reviewText
            })
        })
        .then(response => {
            // 无论成功失败，都先尝试解析JSON，并把响应对象和解析后的数据一起传递下去
            return response.json().then(data => ({ response, data }));
        })
        .then(({ response, data }) => {
            if (response.ok) {
                // --- 请求成功 (状态码 2xx) ---
                messageDiv.innerHTML = '<div class="alert alert-success">评论发表成功！</div>';
                form.reset();
                // 成功后，重新调用 fetchReviews() 来刷新整个评论列表，确保数据最新
                fetchReviews();
            } else {
                // --- 请求失败 (状态码 4xx, 5xx) ---
                let errorMessage = "提交失败，发生未知错误。"; // 默认错误消息

                if (response.status === 401 || response.status === 403) {
                    errorMessage = "请先登录后再发表评论。";
                } else if (data) {
                    // 尝试从返回的JSON中提取更具体的错误信息
                    if (data.non_field_errors) {
                        // 这里会捕获到我们自定义的“重复提交”错误
                        errorMessage = data.non_field_errors.join(' ');
                    } else if (data.detail) {
                        errorMessage = data.detail;
                    }
                }

                messageDiv.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
            }
        })
        .catch(error => {
            console.error('提交评论时发生网络或解析错误:', error);
            messageDiv.innerHTML = '<div class="alert alert-danger">网络连接失败，请稍后重试。</div>';
        });
    });
});
</script>
{% endblock %}